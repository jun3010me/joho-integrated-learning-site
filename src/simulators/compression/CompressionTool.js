export class CompressionTool {
  constructor() {
    this.currentSection = 'run-length'
    this.currentSubsection = { 'run-length': 'basic', 'huffman': 'basic' }
    this.gridData = Array(8).fill().map(() => Array(8).fill(0)) // 0=A, 1=B
    this.practiceGridData = Array(8).fill().map(() => Array(8).fill(0))
    this.huffmanFrequencies = { A: 30, B: 25, C: 20, D: 15, E: 10 }
    this.huffmanCodes = {}
    this.huffmanTree = null
    this.treeSteps = []
    this.currentTreeStep = 0
    this.lastTouch = null // сѓ┐сЃЃсЃЂсЂ«сЃЄсЃљсѓдсЃ│сѓ╣уће
  }

  render(container) {
    container.innerHTML = `
      <div class="simulator-container">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-4">­ЪЌю№ИЈ сЃЄсЃ╝сѓ┐тюДуИ«тГду┐њсЃёсЃ╝сЃФ</h1>
          <p class="text-gray-600">сЃЕсЃ│сЃгсЃ│сѓ░сѓ╣угдтЈитїќсЂесЃЈсЃЋсЃъсЃ│угдтЈитїќсЂ«т«ЪУихтГду┐њ</p>
        </div>

        <!-- сѓ┐сЃќсЃісЃЊсѓ▓сЃ╝сѓисЃДсЃ│ -->
        <div class="card mb-8">
          <div class="flex flex-wrap justify-center gap-2 mb-6">
            <button class="nav-btn active" data-section="run-length">сЃЕсЃ│сЃгсЃ│сѓ░сѓ╣угдтЈитїќ</button>
            <button class="nav-btn" data-section="huffman">сЃЈсЃЋсЃъсЃ│угдтЈитїќ</button>
            <button class="nav-btn" data-section="comparison">Т»ћУ╝ЃсЃ╗уи┤у┐њ</button>
          </div>
        </div>

        <!-- сЃЕсЃ│сЃгсЃ│сѓ░сѓ╣угдтЈитїќсѓ╗сѓ»сѓисЃДсЃ│ -->
        <section id="run-length" class="content-section active">
          <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">сЃЕсЃ│сЃгсЃ│сѓ░сѓ╣угдтЈитїќ</h2>
            
            <div class="flex flex-wrap justify-center gap-2 mb-6">
              <button class="section-btn active" data-subsection="basic">тЪ║ТюгТдѓт┐х</button>
              <button class="section-btn" data-subsection="practice">уи┤у┐њ</button>
              <button class="section-btn" data-subsection="problems">тЋЈжАї</button>
            </div>

            <!-- тЪ║ТюгТдѓт┐х -->
            <div id="rl-basic" class="subsection active">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">8├Ќ8сЃћсѓ»сѓ╗сЃФсѓ░сЃфсЃЃсЃЅ</h3>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- сѓ░сЃфсЃЃсЃЅУАеуц║ -->
                <div class="space-y-4">
                  <div class="flex flex-wrap gap-2 mb-4">
                    <button id="clear-grid" class="btn-secondary text-sm">сѓ»сЃфсѓб</button>
                    <button id="pattern-vertical" class="btn-secondary text-sm">уИдуИъ</button>
                    <button id="pattern-horizontal" class="btn-secondary text-sm">ТефуИъ</button>
                    <button id="pattern-checker" class="btn-secondary text-sm">сЃЂсѓДсЃЃсѓ»</button>
                    <button id="pattern-random" class="btn-secondary text-sm">сЃЕсЃ│сЃђсЃа</button>
                  </div>
                  
                  <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
                    <canvas id="pixel-grid" width="320" height="320" class="border border-gray-400 mx-auto block"></canvas>
                    <div class="flex justify-center gap-4 mt-3">
                      <span class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-blue-500 border border-gray-400"></div>
                        <span class="text-sm">A (0)</span>
                      </span>
                      <span class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-red-500 border border-gray-400"></div>
                        <span class="text-sm">B (1)</span>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- угдтЈитїќжЂјуеІ -->
                <div class="space-y-4">
                  <h4 class="text-lg font-semibold text-gray-800">угдтЈитїќсЂ«жЂјуеІ</h4>
                  <div class="space-y-3">
                    <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                      <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">1</span>
                      <span class="text-sm">ТюђтѕЮсЂ«сЃЊсЃЃсЃѕ№╝ѕУАїсЂћсЂе№╝Ѕ: <span id="first-bit" class="font-mono text-blue-600">-</span></span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                      <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">2</span>
                      <span class="text-sm">ТгАсЂ«3сЃЊсЃЃсЃѕ№╝џТюђтѕЮсЂ«ТќЄтГЌсЂїуХџсЂЈтђІТЋ░-1сѓњУАесЂЎ</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-yellow-50 rounded-lg">
                      <span class="bg-yellow-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">3</span>
                      <span class="text-sm">ТќЄтГЌсЂїтцЅсѓЈсѓІсЂЪсЂ│сЂФсђЂуХџсЂЈтђІТЋ░-1сѓњ3сЃЊсЃЃсЃѕсЂДУАесЂЎ</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
                      <span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">4</span>
                      <span class="text-sm">тљёУАїсЂћсЂесЂФ1сђю3сЂ«сЃФсЃ╝сЃФсЂДугдтЈитїќ</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- тюДуИ«ухљТъю -->
              <div class="mt-8 space-y-4">
                <h4 class="text-lg font-semibold text-gray-800">тюДуИ«ухљТъю</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">тЁЃсЃЄсЃ╝сѓ┐ (64сЃЊсЃЃсЃѕ)</label>
                    <div id="original-bits" class="font-mono text-xs bg-white p-2 rounded border break-all"></div>
                  </div>
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-blue-700 mb-2">тюДуИ«сЃЄсЃ╝сѓ┐</label>
                    <div id="compressed-bits" class="font-mono text-xs bg-white p-2 rounded border break-all"></div>
                    <div id="compressed-size" class="text-sm text-blue-600 mt-1 font-semibold">0сЃЊсЃЃсЃѕ</div>
                  </div>
                  <div class="bg-green-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-green-700 mb-2">тЅіТИЏујЄ</label>
                    <div id="ratio-value" class="text-2xl font-bold text-green-600">0%</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- уи┤у┐њсѓ╗сѓ»сѓисЃДсЃ│ -->
            <div id="rl-practice" class="subsection hidden">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">сѓцсЃ│сѓ┐сЃЕсѓ»сЃєсѓБсЃќуи┤у┐њ</h3>
              <p class="text-gray-600 mb-6">ТДўсђЁсЂфсЃЉсѓ┐сЃ╝сЃ│сѓњСйюТѕљсЂЌсЂдтюДуИ«ті╣Тъюсѓњуб║УфЇсЂЌсѓѕсЂє</p>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
                  <canvas id="practice-grid" width="320" height="320" class="border border-gray-400 mx-auto block"></canvas>
                </div>
                
                <div class="space-y-4">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-gray-700">тЁЃсЃЄсЃ╝сѓ┐сѓхсѓцсѓ║:</span>
                      <span id="practice-original" class="font-mono text-gray-900">64сЃЊсЃЃсЃѕ</span>
                    </div>
                  </div>
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-blue-700">тюДуИ«тЙїсѓхсѓцсѓ║:</span>
                      <span id="practice-compressed" class="font-mono text-blue-900">0сЃЊсЃЃсЃѕ</span>
                    </div>
                  </div>
                  <div class="bg-green-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-green-700">тЅіТИЏујЄ:</span>
                      <span id="practice-ratio" class="font-mono text-green-900">0%</span>
                    </div>
                  </div>
                  <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-yellow-700">УЕЋСЙА:</span>
                      <span id="practice-evaluation" class="font-mono text-yellow-900">-</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- тЋЈжАїсѓ╗сѓ»сѓисЃДсЃ│ -->
            <div id="rl-problems" class="subsection hidden">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">уи┤у┐њтЋЈжАї</h3>
              <div class="space-y-4">
                <button id="generate-rl-problem" class="btn-primary">Тќ░сЂЌсЂётЋЈжАїсѓњућЪТѕљ</button>
                <div id="rl-problem-display" class="mt-4"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- сЃЈсЃЋсЃъсЃ│угдтЈитїќсѓ╗сѓ»сѓисЃДсЃ│ -->
        <section id="huffman" class="content-section hidden">
          <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">сЃЈсЃЋсЃъсЃ│угдтЈитїќ</h2>
            
            <div class="flex flex-wrap justify-center gap-2 mb-6">
              <button class="section-btn active" data-subsection="basic">тЪ║ТюгТдѓт┐х</button>
              <button class="section-btn" data-subsection="tree">ТюеТДІу»Ѕ</button>
              <button class="section-btn" data-subsection="encode">угдтЈитїќуи┤у┐њ</button>
            </div>

            <!-- тЪ║ТюгТдѓт┐х -->
            <div id="hf-basic" class="subsection active">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">тЄ║уЈЙжа╗т║дсЂеугдтЈиУАе</h3>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                  <h4 class="text-lg font-semibold text-gray-800">ТќЄтГЌсЂ«тЄ║уЈЙжа╗т║дсѓњтЁЦтіЏсЂЌсЂдсЂЈсЂасЂЋсЂё (%)</h4>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-3">
                      <div class="flex items-center gap-2">
                        <label class="w-8 text-sm font-medium">A:</label>
                        <input type="number" id="freq-a" min="0" max="100" value="30" class="flex-1 px-2 py-1 border rounded">
                        <span class="text-sm">%</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="w-8 text-sm font-medium">B:</label>
                        <input type="number" id="freq-b" min="0" max="100" value="25" class="flex-1 px-2 py-1 border rounded">
                        <span class="text-sm">%</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="w-8 text-sm font-medium">C:</label>
                        <input type="number" id="freq-c" min="0" max="100" value="20" class="flex-1 px-2 py-1 border rounded">
                        <span class="text-sm">%</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="w-8 text-sm font-medium">D:</label>
                        <input type="number" id="freq-d" min="0" max="100" value="15" class="flex-1 px-2 py-1 border rounded">
                        <span class="text-sm">%</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="w-8 text-sm font-medium">E:</label>
                        <input type="number" id="freq-e" min="0" max="100" value="10" class="flex-1 px-2 py-1 border rounded">
                        <span class="text-sm">%</span>
                      </div>
                    </div>
                    <div class="space-y-3">
                      <div class="bg-gray-100 p-3 rounded">
                        <div class="text-sm font-medium">тљѕУеѕ: <span id="freq-total" class="text-blue-600">100</span>%</div>
                      </div>
                      <button id="build-huffman-tree" class="btn-primary w-full">сЃЈсЃЋсЃъсЃ│ТюесѓњТДІу»Ѕ</button>
                    </div>
                  </div>
                </div>

                <div class="space-y-4">
                  <h4 class="text-lg font-semibold text-gray-800">ућЪТѕљсЂЋсѓїсЂЪугдтЈиУАе</h4>
                  <div class="bg-white border rounded-lg overflow-hidden">
                    <table id="code-table" class="w-full">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">ТќЄтГЌ</th>
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">тЄ║уЈЙжа╗т║д</th>
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">угдтЈи</th>
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">угдтЈижЋи</th>
                        </tr>
                      </thead>
                      <tbody id="code-table-body">
                        <tr><td colspan="4" class="px-3 py-4 text-center text-gray-500">сЃЈсЃЋсЃъсЃ│ТюесѓњТДІу»ЅсЂЌсЂдсЂЈсЂасЂЋсЂё</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- ТюеТДІу»Ѕ -->
            <div id="hf-tree" class="subsection hidden">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">сЃЈсЃЋсЃъсЃ│ТюеТДІу»ЅжЂјуеІ</h3>
              <div class="space-y-4">
                <div class="flex flex-wrap gap-2">
                  <button id="tree-step-back" class="btn-secondary">Тѕ╗сѓІ</button>
                  <button id="tree-step-forward" class="btn-secondary">ТгАсЂИ</button>
                  <button id="tree-auto-play" class="btn-primary">УЄфтІЋтєЇућЪ</button>
                  <button id="tree-reset" class="btn-secondary">сЃфсѓ╗сЃЃсЃѕ</button>
                </div>
                <div class="bg-white border rounded-lg p-4 min-h-96">
                  <svg id="huffman-tree" class="w-full h-96"></svg>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                  <div id="tree-step-text" class="text-blue-800">сЃЈсЃЋсЃъсЃ│ТюеТДІу»Ѕсѓњсѓ╣сЃєсЃЃсЃЌт«ЪУАїсЂДсЂЇсЂЙсЂЎ</div>
                </div>
              </div>
            </div>

            <!-- угдтЈитїќуи┤у┐њ -->
            <div id="hf-encode" class="subsection hidden">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">угдтЈитїќсЃ╗тЙЕтЈитїќуи┤у┐њ</h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                  <div class="space-y-2">
                    <label for="text-input" class="block text-sm font-medium text-gray-700">ТќЄтГЌтѕЌсѓњтЁЦтіЏ:</label>
                    <input type="text" id="text-input" placeholder="СЙІ№╝џABCDE" class="w-full px-3 py-2 border rounded-md">
                    <button id="encode-text" class="btn-primary">угдтЈитїќ</button>
                  </div>
                  
                  <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                    <h5 class="font-semibold text-gray-800">угдтЈитїќухљТъю</h5>
                    <div id="encoded-text" class="font-mono text-sm bg-white p-2 rounded border"></div>
                    <div class="text-xs text-gray-600 space-y-1">
                      <div>тЁЃсѓхсѓцсѓ║: <span id="original-size">0</span>сЃЊсЃЃсЃѕ</div>
                      <div>угдтЈитїќтЙї: <span id="encoded-size">0</span>сЃЊсЃЃсЃѕ</div>
                      <div>тЅіТИЏујЄ: <span id="encode-ratio">0</span>%</div>
                    </div>
                  </div>
                </div>
                
                <div class="space-y-4">
                  <h5 class="font-semibold text-gray-800">тЙЕтЈитїќуб║УфЇ</h5>
                  <div id="decoded-text" class="bg-green-50 p-4 rounded-lg font-mono"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Т»ћУ╝ЃсЃ╗уи┤у┐њсѓ╗сѓ»сѓисЃДсЃ│ -->
        <section id="comparison" class="content-section hidden">
          <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">тюДуИ«Тќ╣т╝ЈТ»ћУ╝ЃсЃ╗уиЈтљѕуи┤у┐њ</h2>
            
            <div class="space-y-6">
              <h3 class="text-xl font-semibold text-gray-800">тљїСИђсЃЄсЃ╝сѓ┐сЂДсЂ«Т»ћУ╝Ѓ</h3>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800"><strong>Т│еТёЈ:</strong> тЇіУДњУІ▒ТЋ░тГЌ№╝ѕA-Z, a-z, 0-9№╝ЅсЂ«сЂ┐тЁЦтіЏтЈ»УЃйсЂДсЂЎсђѓ</p>
                <p class="text-sm text-yellow-800">ТќЄтГЌуе«ТЋ░сЂФт┐юсЂўсЂдТюђжЂЕсЂфсЃЊсЃЃсЃѕТЋ░сЂДУеѕу«ЌсЂЌсЂЙсЂЎсђѓ</p>
              </div>
              
              <div class="space-y-4">
                <textarea id="comparison-text" placeholder="СЙІ: AAABBBCCC сЂЙсЂЪсЂ» ABC123" 
                         class="w-full px-3 py-2 border rounded-md h-24 resize-none"></textarea>
                <button id="compare-methods" class="btn-primary">Т»ћУ╝Ѓт«ЪУАї</button>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                  <h4 class="font-semibold text-gray-800 mb-2">жЮътюДуИ«</h4>
                  <div class="space-y-1 text-sm">
                    <div>сѓхсѓцсѓ║: <span id="uncompressed-size" class="font-mono">0</span>сЃЊсЃЃсЃѕ</div>
                    <div id="bit-calculation" class="text-xs text-gray-600"></div>
                  </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                  <h4 class="font-semibold text-blue-800 mb-2">сЃЕсЃ│сЃгсЃ│сѓ░сѓ╣угдтЈитїќ</h4>
                  <div class="space-y-1 text-sm">
                    <div>сѓхсѓцсѓ║: <span id="rl-comp-size" class="font-mono">0</span>сЃЊсЃЃсЃѕ</div>
                    <div>тЅіТИЏујЄ: <span id="rl-comp-ratio" class="font-mono">0</span>%</div>
                  </div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                  <h4 class="font-semibold text-green-800 mb-2">сЃЈсЃЋсЃъсЃ│угдтЈитїќ</h4>
                  <div class="space-y-1 text-sm">
                    <div>сѓхсѓцсѓ║: <span id="hf-comp-size" class="font-mono">0</span>сЃЊсЃЃсЃѕ</div>
                    <div>тЅіТИЏујЄ: <span id="hf-comp-ratio" class="font-mono">0</span>%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    `

    this.setupEventListeners()
    this.setupCanvas()
    this.updateDisplay()
  }

  setupEventListeners() {
    // сЃАсѓцсЃ│сЃісЃЊсѓ▓сЃ╝сѓисЃДсЃ│
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.switchSection(e.target.dataset.section)
      })
    })

    // сѓ╗сѓ»сѓисЃДсЃ│сЃісЃЊсѓ▓сЃ╝сѓисЃДсЃ│
    document.querySelectorAll('.section-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const section = this.currentSection
        const subsection = e.target.dataset.subsection
        this.switchSubsection(section, subsection)
      })
    })

    // сѓ░сЃфсЃЃсЃЅсѓ│сЃ│сЃѕсЃГсЃ╝сЃФ
    document.getElementById('clear-grid')?.addEventListener('click', () => this.clearGrid())
    document.getElementById('pattern-vertical')?.addEventListener('click', () => this.setPattern('vertical'))
    document.getElementById('pattern-horizontal')?.addEventListener('click', () => this.setPattern('horizontal'))
    document.getElementById('pattern-checker')?.addEventListener('click', () => this.setPattern('checker'))
    document.getElementById('pattern-random')?.addEventListener('click', () => this.setPattern('random'))

    // тЋЈжАїућЪТѕљ
    document.getElementById('generate-rl-problem')?.addEventListener('click', () => this.generateRunLengthProblem())
  }

  switchSection(section) {
    this.currentSection = section
    
    // сЃісЃЊсѓ▓сЃ╝сѓисЃДсЃ│сЃюсѓ┐сЃ│сЂ«уіХТЁІТЏ┤Тќ░
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.section === section)
      btn.className = btn.dataset.section === section ? 'nav-btn btn-primary' : 'nav-btn btn-secondary'
    })

    // сѓ╗сѓ»сѓисЃДсЃ│сЂ«УАеуц║тѕЄсѓіТЏ┐сЂѕ
    document.querySelectorAll('.content-section').forEach(sec => {
      sec.classList.toggle('active', sec.id === section)
      sec.style.display = sec.id === section ? 'block' : 'none'
    })
  }

  switchSubsection(section, subsection) {
    this.currentSubsection[section] = subsection
    
    // сѓхсЃќсѓ╗сѓ»сѓисЃДсЃ│сЃюсѓ┐сЃ│сЂ«уіХТЁІТЏ┤Тќ░
    document.querySelectorAll('.section-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.subsection === subsection)
      btn.className = btn.dataset.subsection === subsection ? 'section-btn btn-primary' : 'section-btn btn-secondary'
    })

    // сѓхсЃќсѓ╗сѓ»сѓисЃДсЃ│сЂ«УАеуц║тѕЄсѓіТЏ┐сЂѕ
    const sectionElement = document.getElementById(section)
    if (sectionElement) {
      sectionElement.querySelectorAll('.subsection').forEach(sub => {
        const isActive = sub.id === `${section.split('-')[0]}-${subsection}`
        sub.classList.toggle('active', isActive)
        sub.classList.toggle('hidden', !isActive)
      })
    }
  }

  setupCanvas() {
    const canvas = document.getElementById('pixel-grid')
    const practiceCanvas = document.getElementById('practice-grid')
    
    if (canvas) {
      this.setupCanvasElement(canvas, 'main')
      this.drawGrid(canvas, this.gridData)
    }
    
    if (practiceCanvas) {
      this.setupCanvasElement(practiceCanvas, 'practice')
      this.drawGrid(practiceCanvas, this.practiceGridData)
    }
  }

  setupCanvasElement(canvas, type) {
    // сЃъсѓдсѓ╣сѓцсЃЎсЃ│сЃѕ
    canvas.addEventListener('click', (e) => this.handleCanvasClick(e, canvas, type))
    
    // сѓ┐сЃЃсЃЂсѓцсЃЎсЃ│сЃѕ
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault()
      this.lastTouch = Date.now()
    })
    
    canvas.addEventListener('touchend', (e) => {
      e.preventDefault()
      if (this.lastTouch && Date.now() - this.lastTouch < 300) {
        this.handleCanvasClick(e.touches[0] || e.changedTouches[0], canvas, type)
      }
    })
  }

  handleCanvasClick(e, canvas, type) {
    const rect = canvas.getBoundingClientRect()
    const x = e.clientX - rect.left
    const y = e.clientY - rect.top
    const cellSize = 40
    
    const col = Math.floor(x / cellSize)
    const row = Math.floor(y / cellSize)
    
    if (col >= 0 && col < 8 && row >= 0 && row < 8) {
      const data = type === 'main' ? this.gridData : this.practiceGridData
      data[row][col] = 1 - data[row][col] // 0Рєњ1, 1Рєњ0
      
      this.drawGrid(canvas, data)
      if (type === 'main') {
        this.updateRunLengthEncoding()
      } else {
        this.updatePracticeResults()
      }
    }
  }

  drawGrid(canvas, data) {
    const ctx = canvas.getContext('2d')
    const cellSize = 40
    
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    
    for (let row = 0; row < 8; row++) {
      for (let col = 0; col < 8; col++) {
        const x = col * cellSize
        const y = row * cellSize
        
        // сѓ╗сЃФсЂ«УЃїТЎ»УЅ▓№╝ѕтЁЃсѓхсѓцсЃѕсЂетљїсЂўУЅ▓№╝Ѕ
        ctx.fillStyle = data[row][col] === 0 ? '#e3f2fd' : '#1976d2'
        ctx.fillRect(x, y, cellSize, cellSize)
        
        // тбЃуЋїуиџ
        ctx.strokeStyle = '#666'
        ctx.lineWidth = 2
        ctx.strokeRect(x, y, cellSize, cellSize)
        
        // сѓ╗сЃФсЂ«ТќЄтГЌ№╝ѕAсЂЙсЂЪсЂ»B№╝Ѕ
        ctx.fillStyle = data[row][col] === 0 ? '#333' : '#fff'
        ctx.font = `${Math.max(16, cellSize * 0.4)}px Arial`
        ctx.textAlign = 'center'
        ctx.textBaseline = 'middle'
        ctx.fillText(
          data[row][col] === 0 ? 'A' : 'B',
          x + cellSize / 2,
          y + cellSize / 2
        )
      }
    }
  }

  clearGrid() {
    this.gridData = Array(8).fill().map(() => Array(8).fill(0))
    const canvas = document.getElementById('pixel-grid')
    if (canvas) {
      this.drawGrid(canvas, this.gridData)
      this.updateRunLengthEncoding()
    }
  }

  setPattern(pattern) {
    switch (pattern) {
      case 'vertical':
        this.gridData = Array(8).fill().map((_, row) => 
          Array(8).fill().map((_, col) => col % 2)
        )
        break
      case 'horizontal':
        this.gridData = Array(8).fill().map((_, row) => 
          Array(8).fill(row % 2)
        )
        break
      case 'checker':
        this.gridData = Array(8).fill().map((_, row) => 
          Array(8).fill().map((_, col) => (row + col) % 2)
        )
        break
      case 'random':
        this.gridData = Array(8).fill().map(() => 
          Array(8).fill().map(() => Math.random() < 0.5 ? 0 : 1)
        )
        break
    }
    
    const canvas = document.getElementById('pixel-grid')
    if (canvas) {
      this.drawGrid(canvas, this.gridData)
      this.updateRunLengthEncoding()
    }
  }

  updateRunLengthEncoding() {
    const originalBits = this.gridData.flat().join('')
    const compressedData = this.runLengthEncode(this.gridData)
    
    // тЁЃсѓхсѓцсЃѕсЂетљїсЂўтюДуИ«ујЄУеѕу«Ќ№╝ѕтюДуИ«тЙїсѓхсѓцсѓ║ / тЁЃсѓхсѓцсѓ║ ├Ќ 100№╝Ѕ
    const originalSize = 64
    const compressedSize = compressedData.totalBits
    const compressionRatio = (compressedSize / originalSize * 100).toFixed(1)
    const reductionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1)
    
    // УАеуц║сѓњТЏ┤Тќ░
    document.getElementById('original-bits').textContent = originalBits
    document.getElementById('compressed-bits').textContent = compressedData.encoding
    document.getElementById('compressed-size').textContent = `${compressedSize}сЃЊсЃЃсЃѕ`
    document.getElementById('ratio-value').textContent = `${reductionRatio}%`
    document.getElementById('first-bit').textContent = this.gridData[0][0] === 0 ? 'A (0)' : 'B (1)'
  }

  runLengthEncode(data) {
    let totalBits = 0
    let allEncodings = []
    
    for (let row = 0; row < 8; row++) {
      const rowResult = this.encodeRow(data[row])
      totalBits += rowResult.bits
      allEncodings.push(rowResult.encoding)
    }
    
    return {
      totalBits,
      encoding: allEncodings.join(' | '),
      details: allEncodings
    }
  }

  encodeRow(rowData) {
    const encodingParts = []
    let totalBits = 1 // ТюђтѕЮсЂ«сЃЊсЃЃсЃѕ№╝ѕУАїсЂ«жќІтДІТќЄтГЌ№╝Ѕ
    let count = 1
    let currentValue = rowData[0]
    
    // ТюђтѕЮсЂ«сЃЊсЃЃсЃѕ: A=0, B=1
    const firstBit = currentValue.toString()
    
    for (let i = 1; i < rowData.length; i++) {
      if (rowData[i] === currentValue && count < 8) { // ТюђтцД8жђБуХџ№╝ѕ3сЃЊсЃЃсЃѕсЂД0-7сѓњУАеуЈЙсђЂcount-1№╝Ѕ
        count++
      } else {
        // тђІТЋ░-1сѓњУеўжї▓№╝ѕу»ётЏ▓0-7№╝Ѕ
        const countMinus1 = count - 1
        encodingParts.push(countMinus1.toString(2).padStart(3, '0'))
        totalBits += 3
        
        if (rowData[i] !== currentValue) {
          // ТќЄтГЌсЂїтцЅсѓЈсЂБсЂЪ
          currentValue = rowData[i]
          count = 1
        } else {
          // 9тђІуЏ«С╗ЦжЎЇсЂ»Тќ░сЂЌсЂёсЃќсЃГсЃЃсѓ»жќІтДІ
          count = 1
        }
      }
    }
    
    // ТюђтЙїсЂ«тђІТЋ░
    const countMinus1 = count - 1
    encodingParts.push(countMinus1.toString(2).padStart(3, '0'))
    totalBits += 3
    
    return {
      bits: totalBits, // 1сЃЊсЃЃсЃѕ№╝ѕТюђтѕЮсЂ«ТќЄтГЌ№╝Ѕ + 3сЃЊсЃЃсЃѕ ├Ќ сЃЕсЃ│сЂ«ТЋ░
      encoding: `${firstBit} ${encodingParts.join(' ')}`,
      firstBit: firstBit
    }
  }

  updatePracticeResults() {
    const compressedData = this.runLengthEncode(this.practiceGridData)
    const originalSize = 64
    const compressedSize = compressedData.totalBits
    const reductionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1)
    
    document.getElementById('practice-original').textContent = `${originalSize}сЃЊсЃЃсЃѕ`
    document.getElementById('practice-compressed').textContent = `${compressedSize}сЃЊсЃЃсЃѕ`
    document.getElementById('practice-ratio').textContent = `${reductionRatio}%`
    
    // УЕЋСЙА
    let evaluation = ''
    if (reductionRatio > 50) evaluation = 'тёфуДђ№╝Ђ'
    else if (reductionRatio > 25) evaluation = 'УЅ»тЦй'
    else if (reductionRatio > 0) evaluation = 'сЂЙсЂџсЂЙсЂџ'
    else evaluation = 'тюДуИ«ті╣ТъюсЂфсЂЌ'
    
    document.getElementById('practice-evaluation').textContent = evaluation
  }

  generateRunLengthProblem() {
    const problems = [
      'тЁесЂдтљїсЂўУЅ▓сЂ«сЃЉсѓ┐сЃ╝сЃ│сѓњСйюТѕљсЂЌсЂдсЂЈсЂасЂЋсЂё№╝ѕтюДуИ«ујЄсЂ»сЂЕсЂєсЂфсѓІ№╝Ъ№╝Ѕ',
      'уИдуИъсЃЉсѓ┐сЃ╝сЃ│сЂДТюђсѓѓтюДуИ«ті╣ТъюсЂ«жФўсЂёсЃЉсѓ┐сЃ╝сЃ│сѓњСйюТѕљсЂЌсЂдсЂЈсЂасЂЋсЂё',
      'сЃЂсѓДсЃЃсѓФсЃ╝сЃюсЃ╝сЃЅсЃЉсѓ┐сЃ╝сЃ│сѓњСйюТѕљсЂЌсђЂтюДуИ«ујЄсѓњуб║УфЇсЂЌсЂдсЂЈсЂасЂЋсЂё',
      'тюДуИ«ујЄсЂї50%С╗ЦСИісЂФсЂфсѓІсЃЉсѓ┐сЃ╝сЃ│сѓњСйюТѕљсЂЌсЂдсЂЈсЂасЂЋсЂё'
    ]
    
    const randomProblem = problems[Math.floor(Math.random() * problems.length)]
    const display = document.getElementById('rl-problem-display')
    
    if (display) {
      display.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-semibold text-blue-800 mb-2">тЋЈжАї</h4>
          <p class="text-blue-700">${randomProblem}</p>
        </div>
      `
    }
  }

  updateDisplay() {
    this.updateRunLengthEncoding()
  }

  cleanup() {
    // сѓ»сЃфсЃ╝сЃ│сѓбсЃЃсЃЌтЄдуљє
  }
}